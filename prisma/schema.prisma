// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String            @id @default(uuid())
  name                       String
  email                      String            @unique
  password_hash              String
  role                       UserRole
  username                   String?           @unique
  phone_number               String?
  logo                       String?
  bio                        String?
  emailVerified              Boolean           @default(false)
  verificationToken          String?
  resetPasswordToken         String?           @unique
  resetPasswordExpires       DateTime?
  twoFactorEnabled           Boolean           @default(true)
  twoFactorCode              String?
  twoFactorExpiresAt         DateTime?
  resetPasswordCode          String?
  resetPasswordCodeExpiresAt DateTime?
  created_at                 DateTime          @default(now())
  updated_at                 DateTime          @updatedAt
  provider                   AuthProvider      @default(CREDENTIALS)
  isDeleted                  Boolean           @default(false)
  deletedAt                  DateTime?
  last_login                 DateTime?
  last_password_change       DateTime?
  is_verified                Boolean           @default(false)
  verification_notes         String?
  verification_docs          Json?
  address                    Json?
  socials                    Json?
  ActivityLog                ActivityLog[]
  reviewsReceived            AgentReview[]     @relation("AgentReviewed")
  agentReviews               AgentReview[]     @relation("AgentReviewer")
  Articles                   Article[]
  Comments                   Comment[]
  handledLeads               Lead[]            @relation("LeadHandler")
  submittedLeads             Lead[]            @relation("LeadSubmitter")
  notifications              Notification[]
  Payment                    Payment[]
  PaystackCustomer           PaystackCustomer?
  properties                 Property[]        @relation("user_properties")
  propertyReviews            PropertyReview[]
  saved_searches             SavedSearch[]
  Subscriptions              Subscription[]
  saved_articles             Article[]         @relation("saved_articles")
  saved_properties           Property[]        @relation("saved_properties")

   ReportsMade       Report[]         @relation("ReportsMade")      // reports the user filed
  ReportsHandled    Report[]         @relation("ReportsHandled")   // reports handled by this admin
  UserReports       Report[]         @relation("UserReports")      // reports where this user was the target
}

model Property {
  id               String           @id @default(uuid())
  agentId          String?
  title            String
  description      String
  bedrooms         String
  bathrooms        String
  toilets          String
  size_sqm         Float
  price            Float
  discount_percent Float?
  discounted_price Float?
  property_type    PropertyType
  listing_type     ListingType
  furnishing       Furnishing
  status           PropertyStatus
  amenities        String[]
  date_added       DateTime         @default(now())
  date_modified    DateTime         @updatedAt
  images           String[]
  street           String
  city             String
  state            String
  lat              Float?
  lon              Float?
  parking_spaces   String?
  approval_status  ApprovalStatus   @default(pending)
  approval_notes   String?
  isDeleted        Boolean          @default(false)
  deletedAt        DateTime?
  currency         currency         @default(NGN)
  video_link       String?
  availability     String?
  tenancy_info     String?
  service_charge   String?
  min_tenancy      String?
  deposit          Float?
  visibility       VisibilityLevel  @default(low)
  is_featured      Boolean          @default(false)
  leads            Lead[]
  agent            User?            @relation("user_properties", fields: [agentId], references: [id])
  reviews          PropertyReview[]
  saved_by         User[]           @relation("saved_properties")
    PropertyReports   Report[]         @relation("PropertyReports")  // reports about this property
}

model Article {
  id          String        @id @default(uuid())
  title       String
  slug        String        @unique
  contentHTML String
  contentJSON String
  coverImage  String?
  status      ArticleStatus @default(DRAFT)
  editorNotes String?
  views       Int           @default(0)
  authorId    String
  length      Int?
  publishedAt DateTime?
  isDeleted   Boolean       @default(false)
  deletedAt   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  tags        String[]
  author      User          @relation(fields: [authorId], references: [id])
  Comments    Comment[]
  User        User[]        @relation("saved_articles")
}

model Comment {
  id          String    @id @default(uuid())
  comment     String
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  commenterId String
  articleId   String
  article     Article   @relation(fields: [articleId], references: [id])
  commenter   User      @relation(fields: [commenterId], references: [id])
}

model Lead {
  id             String     @id @default(uuid())
  propertyId     String?
  userId         String?
  agentId        String?
  name           String?
  email          String?
  message        String
  status         LeadStatus @default(new)
  closure_reason String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  agent          User?      @relation("LeadHandler", fields: [agentId], references: [id])
  property       Property?  @relation(fields: [propertyId], references: [id])
  user           User?      @relation("LeadSubmitter", fields: [userId], references: [id])
}

model Notification {
  id              String           @id @default(uuid())
  recipientId     String
  title           String           @default("")
  type            NotificationType @default(IN_APP)
  message         String           @default("")
  linkUrl         String?
  metadata        Json?
  isRead          Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  category        String?
  relatedEntityId String?
  recipient       User             @relation(fields: [recipientId], references: [id])
}

model SavedSearch {
  id             String           @id @default(uuid())
  userId         String
  name           String?
  query          Json
  sendAlerts     Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  last_checked   DateTime         @default(now())
  user           User             @relation(fields: [userId], references: [id])
  SearchAlertLog SearchAlertLog[]
}

model SearchAlertLog {
  id           String           @id @default(uuid())
  searchId     String
  userId       String
  result_count Int
  method       NotificationType
  notified_at  DateTime         @default(now())
  search       SavedSearch      @relation(fields: [searchId], references: [id])
}

model SubscriptionTier {
  id               String               @id @default(uuid())
  name             SubscriptionTierType @unique
  features         Json?
  description      String?
  rank             Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  subscriptions    Subscription[]
  SubscriptionPlan SubscriptionPlan[]
}

model Subscription {
  id                       String           @id @default(uuid())
  agentId                  String
  planId                   String
  startDate                DateTime
  endDate                  DateTime?
  isActive                 Boolean          @default(true)
  manuallyGranted          Boolean          @default(false)
  paystackPlanCode         String?
  paystackSubscriptionCode String?          @unique
  paystackCustomerCode     String?
  paystackEmailToken       String?
  paystackInvoiceToken     String?
  nextPaymentDate          DateTime?
  gracePeriodEndDate       DateTime?
  createdAt                DateTime         @default(now())
  payments                 Payment[]
  agent                    User             @relation(fields: [agentId], references: [id])
  plan                     SubscriptionTier @relation(fields: [planId], references: [id])
}

model PaystackCustomer {
  userId       String @id
  customerCode String @unique
  user         User   @relation(fields: [userId], references: [id])
}

model SubscriptionPlan {
  id               String           @id @default(uuid())
  tierId           String
  duration         Duration
  price            Int
  createdAt        DateTime         @default(now())
  paystackPlanCode String?
  tier             SubscriptionTier @relation(fields: [tierId], references: [id])
}

model Payment {
  id             String          @id @default(uuid())
  userId         String
  subscriptionId String?
  amount         Int
  currency       String          @default("NGN")
  status         PaymentStatus   @default(PENDING)
  reference      String          @unique
  purpose        PaymentPurpose  @default(SUBSCRIPTION)
  provider       PaymentProvider
  createdAt      DateTime        @default(now())
  updatedAt      DateTime?
  subscription   Subscription?   @relation(fields: [subscriptionId], references: [id])
  user           User            @relation(fields: [userId], references: [id])
}

model AgentReview {
  id         String   @id @default(uuid())
  reviewerId String
  agentId    String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  agent      User     @relation("AgentReviewed", fields: [agentId], references: [id])
  reviewer   User     @relation("AgentReviewer", fields: [reviewerId], references: [id])
}

model PropertyReview {
  id         String   @id @default(uuid())
  reviewerId String
  propertyId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  property   Property @relation(fields: [propertyId], references: [id])
  reviewer   User     @relation(fields: [reviewerId], references: [id])
}

model ActivityLog {
  id          String           @id @default(uuid())
  userId      String?
  category    ActivityCategory
  action      String
  description String?
  ipAddress   String?
  userAgent   String?
  changes     Json?
  metadata    Json?
  createdAt   DateTime         @default(now())
  user        User?            @relation(fields: [userId], references: [id])
}

model Report {
  id          String       @id @default(uuid())
  reporterId  String?
  targetType  ReportTarget
  reason      ReportReason
  message     String?
  attachments Json?
  status      ReportStatus @default(NEW)
  adminNotes  String?
  actionTaken String?
  handledById String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
   // Relations
  reporter         User?        @relation("ReportsMade", fields: [reporterId], references: [id])
  handledBy        User?        @relation("ReportsHandled", fields: [handledById], references: [id])
  targetUser       User?        @relation("UserReports", fields: [targetUserId], references: [id])
  targetUserId     String?
  targetProperty   Property?    @relation("PropertyReports", fields: [targetPropertyId], references: [id])
  targetPropertyId String?
  @@index([status, createdAt])
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReportTarget {
  PROPERTY
  AGENT
}

enum ReportReason {
  FRAUD
  FALSE_LISTING
  ILLEGAL_ACTIVITY
  SPAM
  INAPPROPRIATE_CONTENT
  OTHER
}

enum ReportStatus {
  NEW
  UNDER_REVIEW
  ACTIONED
  DISMISSED
}

enum ActivityCategory {
  AUTH
  ACCOUNT
  USER_ACTION
  CRITICAL
  SYSTEM
  ADMIN_ACTION
}

enum currency {
  USD
  NGN
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  COMPLIMENTARY
}

enum PaymentProvider {
  PAYSTACK
  FLUTTERWAVE
  MANUAL
}

enum NotificationType {
  IN_APP
  EMAIL
}

enum LeadStatus {
  new
  contacted
  in_progress
  closed
}

enum Duration {
  MONTHLY
  YEARLY
}

enum UserRole {
  buyer
  agent
  admin
}

enum PropertyType {
  apartment
  detached
  semi_detached
  terrace
  land
  commercial
  warehouse
}

enum ListingType {
  sale
  rent
  shortlet
}

enum Furnishing {
  furnished
  unfurnished
  partly_furnished
}

enum PropertyStatus {
  available
  sold
  rented
  unavailable
  unlisted
}

enum SubscriptionTierType {
  standard
  pro
  premium
}


enum ApprovalStatus {
  approved
  pending
  rejected
}

enum VisibilityLevel {
  low
  medium
  high
}

enum PaymentPurpose {
  SUBSCRIPTION
  PROPERTY_BOOST
  FEATURE_UPGRADE
  CUSTOM
}

enum AuthProvider {
  GOOGLE
  CREDENTIALS
}

